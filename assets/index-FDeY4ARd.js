(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();class g{constructor(t,e){this.width=t,this.height=e,this.gravity=.4,this.bodies=[],this.onCollision=null,this.damping=.995,this.restitution=.6,this.iterations=2}createCircle(t,e,i,s={}){const r={id:Math.random().toString(36).substr(2,9),x:t,y:e,vx:s.vx||0,vy:s.vy||0,radius:i,mass:Math.PI*i*i*.01,isStatic:s.isStatic||!1,restitution:s.restitution??this.restitution,fruitLevel:s.fruitLevel??0,markedForRemoval:!1,settled:!1,settledTimer:0};return this.bodies.push(r),r}removeBody(t){t.markedForRemoval=!0}update(t=1){this.bodies=this.bodies.filter(i=>!i.markedForRemoval);const e=this.bodies;for(const i of e)i.isStatic||(i.vy+=this.gravity*t,i.vx*=this.damping,i.vy*=this.damping,i.x+=i.vx*t,i.y+=i.vy*t);for(let i=0;i<this.iterations;i++){for(const s of e)s.isStatic||this._constrainToWalls(s);for(let s=0;s<e.length;s++)for(let r=s+1;r<e.length;r++){const o=e[s],n=e[r];o.markedForRemoval||n.markedForRemoval||this._resolveCircleCollision(o,n,i===0)}}for(const i of e){if(i.isStatic)continue;Math.sqrt(i.vx*i.vx+i.vy*i.vy)<.5?(i.settledTimer++,i.settledTimer>30&&(i.settled=!0)):(i.settledTimer=0,i.settled=!1)}}_constrainToWalls(t){t.x-t.radius<0&&(t.x=t.radius,t.vx=Math.abs(t.vx)*t.restitution),t.x+t.radius>this.width&&(t.x=this.width-t.radius,t.vx=-Math.abs(t.vx)*t.restitution),t.y+t.radius>this.height&&(t.y=this.height-t.radius,t.vy=-Math.abs(t.vy)*t.restitution,Math.abs(t.vy)<.15&&(t.vy=0))}_resolveCircleCollision(t,e,i){const s=e.x-t.x,r=e.y-t.y,o=s*s+r*r,n=t.radius+e.radius;if(o>=n*n)return;if(o===0){e.x+=.1;return}const h=Math.sqrt(o),l=s/h,d=r/h,u=(n-h)/2+.01;t.isStatic||(t.x-=l*u,t.y-=d*u),e.isStatic||(e.x+=l*u,e.y+=d*u);const m=.3;t.isStatic||(t.vx-=l*m,t.vy-=d*m),e.isStatic||(e.vx+=l*m,e.vy+=d*m),this.onCollision&&this.onCollision(t,e)}resize(t,e){this.width=t,this.height=e}}const a=[{name:"Cherry",emoji:"üçí",radius:15,color:"#e74c3c",points:1},{name:"Strawberry",emoji:"üçì",radius:20,color:"#ff6b81",points:3},{name:"Grape",emoji:"üçá",radius:25,color:"#8e44ad",points:6},{name:"Orange",emoji:"üçä",radius:32,color:"#f39c12",points:10},{name:"Apple",emoji:"üçé",radius:38,color:"#e74c3c",points:15},{name:"Pear",emoji:"üçê",radius:44,color:"#a8d948",points:21},{name:"Peach",emoji:"üçë",radius:50,color:"#fdcb6e",points:28},{name:"Pineapple",emoji:"üçç",radius:56,color:"#f9ca24",points:36},{name:"Melon",emoji:"üçà",radius:63,color:"#6ab04c",points:45},{name:"Watermelon",emoji:"üçâ",radius:72,color:"#27ae60",points:55}],x=4;class y{constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.particles=[]}resize(t,e,i){this.canvas.width=t*i,this.canvas.height=e*i,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.ctx.setTransform(i,0,0,i,0,0),this.dpr=i}clear(){this.ctx.clearRect(0,0,this.canvas.width/this.dpr,this.canvas.height/this.dpr)}drawFruit(t){const e=this.ctx,i=a[t.fruitLevel];if(!i)return;e.save(),e.translate(t.x,t.y);const s=e.createRadialGradient(-t.radius*.3,-t.radius*.3,t.radius*.1,0,0,t.radius);s.addColorStop(0,this._lightenColor(i.color,40)),s.addColorStop(1,i.color),e.beginPath(),e.arc(0,0,t.radius,0,Math.PI*2),e.fillStyle=s,e.fill(),e.strokeStyle=this._darkenColor(i.color,30),e.lineWidth=2,e.stroke();const r=t.radius*1.1;e.font=`${r}px serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(i.emoji,0,2),e.restore()}drawDangerLine(t){const e=this.ctx,i=this.canvas.width/this.dpr;e.save(),e.setLineDash([8,6]),e.strokeStyle="rgba(255, 80, 80, 0.5)",e.lineWidth=2,e.beginPath(),e.moveTo(0,t),e.lineTo(i,t),e.stroke(),e.setLineDash([]),e.restore()}drawPendingFruit(t,e,i){const s=this.ctx,r=a[e];if(!r)return;s.save(),s.globalAlpha=.7,s.translate(t,i+10),s.beginPath(),s.arc(0,0,i,0,Math.PI*2),s.fillStyle=r.color,s.fill();const o=i*1.1;s.font=`${o}px serif`,s.textAlign="center",s.textBaseline="middle",s.fillText(r.emoji,0,2),s.restore()}addMergeParticles(t,e,i,s=10){for(let r=0;r<s;r++){const o=Math.PI*2*r/s,n=2+Math.random()*3;this.particles.push({x:t,y:e,vx:Math.cos(o)*n,vy:Math.sin(o)*n,radius:3+Math.random()*4,color:i,life:1,decay:.03+Math.random()*.02})}}drawParticles(){const t=this.ctx;for(let e=this.particles.length-1;e>=0;e--){const i=this.particles[e];if(i.x+=i.vx,i.y+=i.vy,i.vy+=.1,i.life-=i.decay,i.life<=0){this.particles.splice(e,1);continue}t.save(),t.globalAlpha=i.life,t.beginPath(),t.arc(i.x,i.y,i.radius*i.life,0,Math.PI*2),t.fillStyle=i.color,t.fill(),t.restore()}}drawNextFruit(t,e){const i=t.getContext("2d"),s=window.devicePixelRatio||1,r=60;t.width=r*s,t.height=r*s,t.style.width=r+"px",t.style.height=r+"px",i.setTransform(s,0,0,s,0,0),i.clearRect(0,0,r,r);const o=a[e];if(!o)return;const n=Math.min(22,o.radius*.7);i.beginPath(),i.arc(r/2,r/2,n,0,Math.PI*2),i.fillStyle=o.color,i.fill();const h=n*1.2;i.font=`${h}px serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(o.emoji,r/2,r/2+1)}_lightenColor(t,e){const i=parseInt(t.replace("#",""),16),s=Math.min(255,(i>>16)+e),r=Math.min(255,(i>>8&255)+e),o=Math.min(255,(i&255)+e);return`rgb(${s},${r},${o})`}_darkenColor(t,e){const i=parseInt(t.replace("#",""),16),s=Math.max(0,(i>>16)-e),r=Math.max(0,(i>>8&255)-e),o=Math.max(0,(i&255)-e);return`rgb(${s},${r},${o})`}}const f=80,v=500,_=3e3;class w{constructor(){this.canvas=document.getElementById("game-canvas"),this.nextCanvas=document.getElementById("next-canvas"),this.dropLine=document.getElementById("drop-line"),this.scoreEl=document.getElementById("score"),this.bestScoreEl=document.getElementById("best-score"),this.finalScoreEl=document.getElementById("final-score"),this.gameOverOverlay=document.getElementById("game-over-overlay"),this.restartBtn=document.getElementById("restart-btn"),this.renderer=new y(this.canvas),this.score=0,this.bestScore=parseInt(localStorage.getItem("fruitMergeBest")||"0",10),this.bestScoreEl.textContent=this.bestScore,this.gameOver=!1,this.dropX=0,this.currentLevel=0,this.nextLevel=0,this.canDrop=!0,this.lastDropTime=0,this._initSize(),this._initPhysics(),this._pickNextFruit(),this._pickNextFruit(),this._bindEvents(),this._loop()}_initSize(){const e=document.getElementById("game-container").getBoundingClientRect();this.width=e.width,this.height=e.height,this.dpr=window.devicePixelRatio||1,this.renderer.resize(this.width,this.height,this.dpr),this.dropX=this.width/2}_initPhysics(){this.physics=new g(this.width,this.height),this.physics.onCollision=(t,e)=>this._onCollision(t,e)}_pickNextFruit(){this.currentLevel=this.nextLevel,this.nextLevel=Math.floor(Math.random()*(x+1)),this.renderer.drawNextFruit(this.nextCanvas,this.nextLevel)}_bindEvents(){const t=document.getElementById("game-container");t.addEventListener("pointerdown",e=>this._onPointerDown(e)),t.addEventListener("pointermove",e=>this._onPointerMove(e)),t.addEventListener("pointerup",e=>this._onPointerUp(e)),this.restartBtn.addEventListener("click",()=>this.restart()),window.addEventListener("resize",()=>this._onResize())}_getPointerX(t){const e=this.canvas.getBoundingClientRect();return t.clientX-e.left}_onPointerDown(t){this.gameOver||(t.preventDefault(),this.dropX=this._clampX(this._getPointerX(t)),this._updateDropLine())}_onPointerMove(t){this.gameOver||(t.preventDefault(),this.dropX=this._clampX(this._getPointerX(t)),this._updateDropLine())}_onPointerUp(t){this.gameOver||(t.preventDefault(),this.dropX=this._clampX(this._getPointerX(t)),this._drop())}_clampX(t){const e=a[this.currentLevel].radius;return Math.max(e,Math.min(this.width-e,t))}_updateDropLine(){this.dropLine.style.left=this.dropX+"px"}_onResize(){const t=this.width,e=this.height;this._initSize(),this.physics.resize(this.width,this.height);const i=this.width/t,s=this.height/e;for(const r of this.physics.bodies)r.x*=i,r.y*=s}_drop(){if(!this.canDrop)return;const t=performance.now();if(t-this.lastDropTime<v)return;const e=a[this.currentLevel],i=this.physics.createCircle(this.dropX,e.radius+10,e.radius,{fruitLevel:this.currentLevel});i.dangerTimer=0,this.canDrop=!1,this.lastDropTime=t,setTimeout(()=>{this.canDrop=!0},v),this._pickNextFruit()}_onCollision(t,e){if(t.fruitLevel!==e.fruitLevel||t.markedForRemoval||e.markedForRemoval)return;const i=t.fruitLevel;if(i>=a.length-1){this._addScore(a[i].points*2),this.renderer.addMergeParticles(t.x,t.y,a[i].color,20),this.physics.removeBody(t),this.physics.removeBody(e);return}const s=i+1,r=a[s],o=(t.x+e.x)/2,n=(t.y+e.y)/2;this.physics.removeBody(t),this.physics.removeBody(e);const h=this.physics.createCircle(o,n,r.radius,{fruitLevel:s,vy:-1});h.dangerTimer=0,this._addScore(r.points),this.renderer.addMergeParticles(o,n,r.color,12)}_addScore(t){this.score+=t,this.scoreEl.textContent=this.score,this.score>this.bestScore&&(this.bestScore=this.score,this.bestScoreEl.textContent=this.bestScore,localStorage.setItem("fruitMergeBest",this.bestScore.toString()))}_checkGameOver(){for(const t of this.physics.bodies)if(!(t.isStatic||t.markedForRemoval))if(t.y-t.radius<f&&t.settled){if(t.dangerTimer=(t.dangerTimer||0)+16,t.dangerTimer>_){this._triggerGameOver();return}}else t.dangerTimer=0}_triggerGameOver(){this.gameOver=!0,this.finalScoreEl.textContent=this.score,this.gameOverOverlay.classList.remove("hidden")}restart(){this.gameOver=!1,this.score=0,this.scoreEl.textContent="0",this.gameOverOverlay.classList.add("hidden"),this._initPhysics(),this._pickNextFruit(),this._pickNextFruit(),this.canDrop=!0}_loop(){this.gameOver||(this.physics.update(1),this._checkGameOver()),this.renderer.clear(),this.renderer.drawDangerLine(f);for(const t of this.physics.bodies)t.markedForRemoval||this.renderer.drawFruit(t);if(!this.gameOver&&this.canDrop){const t=a[this.currentLevel].radius;this.renderer.drawPendingFruit(this.dropX,this.currentLevel,t)}this.renderer.drawParticles(),requestAnimationFrame(()=>this._loop())}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",p):p();function p(){document.body.addEventListener("touchmove",c=>c.preventDefault(),{passive:!1}),new w,"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(()=>{console.log("Service worker registered")}).catch(c=>{console.warn("SW registration failed:",c)})}
